@model WebSIMS.Models.ViewModels.InforManagerViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Infor Manager";
    Layout = "_Layout";
}

<h2>Infor Manager</h2>

@if (TempData["Notification"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Notification"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="form-group mb-3">
    <label for="roleSelect" class="control-label">Select Role</label>
    <select id="roleSelect" class="form-control">
        <option value="">Select Role</option>
        <option value="Student">Student</option>
        <option value="Lecturer">Lecturer</option>
    </select>
</div>

<table id="inforTable" class="table table-bordered table-hover" style="display: none;">
    <thead>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Join Date</th>
            <th>Birth Date</th>
            <th>Code Id</th>
            <th>Phone Number</th>
            <th>User Id</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#roleSelect').change(function () {
                var role = $(this).val();
                if (role) {
                    $.getJSON('@Url.Action("GetInforListByRole", "Admin")', { role: role })
                        .done(function (data) {
                            var tableBody = $('#inforTable tbody');
                            tableBody.empty();
                            $.each(data, function (index, item) {
                                var row = '<tr>' +
                                    '<td>' + item.id + '</td>' +
                                    '<td>' + item.name + '</td>' +
                                    '<td>' + item.joinDate + '</td>' +
                                    '<td>' + item.birthDate + '</td>' +
                                    '<td>' + item.codeId + '</td>' +
                                    '<td>' + (item.phoneNumber || '') + '</td>' +
                                    '<td>' + item.userId + '</td>' +
                                    '<td>' +
                                        '<a href="/Admin/EditUserInfor?role=' + role + '" class="btn btn-sm btn-primary">Edit</a>' +
                                        '<button class="btn btn-sm btn-danger deleteBtn" data-id="' + item.id + '" data-role="' + role + '">Delete</button>' +
                                    '</td>' +
                                    '</tr>';
                                tableBody.append(row);
                            });
                            $('#inforTable').show();
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            console.error("Error loading infor list:", textStatus, errorThrown);
                            alert("Failed to load infor list. Please try again.");
                        });
                } else {
                    $('#inforTable').hide();
                }
            });

            // Xử lý delete
            $(document).on('click', '.deleteBtn', function () {
                var id = $(this).data('id');
                var role = $(this).data('role');
                if (confirm('Are you sure you want to delete this information?')) {
                    $.post('@Url.Action("ManagerDeleteUserInfor", "Admin")', { id: id, role: role })
                        .done(function (response) {
                            alert("Deleted successfully.");
                            $('#roleSelect').change(); // Reload bảng
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            console.error("Error deleting infor:", textStatus, errorThrown);
                            alert("Failed to delete. Please try again.");
                        });
                }
            });
        });
    </script>
}