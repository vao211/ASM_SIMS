@model WebSIMS.Models.ViewModels.AssignUserInforViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
ViewData["Title"] = "Assign User to Information";
Layout = "_Layout";
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_back" />
    <link rel="stylesheet" href="~/css/assign-user-infor.css" />
</head>

<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <div class="d-flex align-items-center">
            <a class="nav-link btn-back" href="@Url.Action("Index", "Dashboard")">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <a class="navbar-brand" href="#">Assign User to Information</a>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="main-content">
    <div class="container">
        <h2>Assign User to Information</h2>

        @if (TempData["Notification"] != null)
        {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Notification"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        }

        @if (TempData["Error"] != null)
        {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        }

        <div class="form-group">
            <label asp-for="Role" class="control-label"></label>
            <select asp-for="Role" asp-items="Model.RoleList" class="form-control" id="roleSelect">
                <option value="">Select Role</option>
            </select>
            <span asp-validation-for="Role" class="text-danger"></span>
        </div>

        <form asp-action="AssignUserInfor" method="post">
            <input type="hidden" asp-for="Role" />
            <input type="hidden" asp-for="InforId" />
            <input type="hidden" asp-for="UserId" />
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="row">
                <div class="col-md-6">
                    <h4>Information Details</h4>
                    <div class="form-group">
                        <label for="inforSelect" class="control-label">Select Information</label>
                        <select id="inforSelect" class="form-control">
                            <option value="">Select Name</option>
                        </select>
                        <span class="text-danger" id="inforSelectError"></span>
                    </div>
                    <table class="table table-bordered">
                        <tr><th>Name</th><td id="inforName"></td></tr>
                        <tr><th>Code ID</th><td id="inforCodeId"></td></tr>
                        <tr><th>Join Date</th><td id="inforJoinDate"></td></tr>
                        <tr><th>Birth Date</th><td id="inforBirthDate"></td></tr>
                        <tr><th>Phone Number</th><td id="inforPhoneNumber"></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4>User Details</h4>
                    <div class="form-group">
                        <label for="userSelect" class="control-label">Select User</label>
                        <select id="userSelect" class="form-control">
                            <option value="">Select User</option>
                        </select>
                        <span class="text-danger" id="userSelectError"></span>
                    </div>
                    <table class="table table-bordered">
                        <tr><th>Name</th><td id="userName"></td></tr>
                        <tr><th>Email</th><td id="userEmail"></td></tr>
                        <tr><th>Role</th><td id="userRole"></td></tr>
                    </table>
                </div>
            </div>

            <div class="form-group form-buttons">
                <input type="submit" value="Assign" class="btn btn-primary" id="assignButton" />
                <a asp-controller="Dashboard" asp-action="Index" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/additional-methods.min.js"></script>

<script>
    $(document).ready(function () {
        // Xử lý change role
        $('#roleSelect').change(function () {
            var role = $(this).val();
            $('#inforSelectError').text('');
            $('#userSelectError').text('');
            $('#Role').val(role);
            if (role) {
                // Load Infor list
                $.getJSON('/Admin/GetInforList', { role: role })
                    .done(function (data) {
                        var inforSelect = $('#inforSelect');
                        inforSelect.empty();
                        inforSelect.append('<option value="">Select Name</option>');
                        $.each(data, function (index, item) {
                            inforSelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("Error loading info list:", textStatus, errorThrown);
                        $('#inforSelectError').text("Failed to load names. Please try again.");
                    });

                // Load User list
                $.getJSON('/Admin/GetUnassignedUsers', { role: role })
                    .done(function (data) {
                        var userSelect = $('#userSelect');
                        userSelect.empty();
                        userSelect.append('<option value="">Select User</option>');
                        $.each(data, function (index, item) {
                            userSelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("Error loading user list:", textStatus, errorThrown);
                        $('#userSelectError').text("Failed to load users. Please try again.");
                    });
            } else {
                $('#inforSelect').empty().append('<option value="">Select Name</option>');
                $('#userSelect').empty().append('<option value="">Select User</option>');
                clearInforDetails();
                clearUserDetails();
            }
        });

        // Xử lý change Infor
        $('#inforSelect').change(function () {
            var id = $(this).val();
            var role = $('#roleSelect').val();
            $('#inforSelectError').text('');
            if (id && role) {
                $('#InforId').val(id);
                $.getJSON('/Admin/GetInforDetails', { id: id, role: role })
                    .done(function (data) {
                        $('#inforName').text(data.name);
                        $('#inforCodeId').text(data.codeId);
                        $('#inforJoinDate').text(data.joinDate.split('T')[0]);
                        $('#inforBirthDate').text(data.birthDate.split('T')[0]);
                        $('#inforPhoneNumber').text(data.phoneNumber || '');
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("Error loading info details:", textStatus, errorThrown);
                        $('#inforSelectError').text("Failed to load details. Please try again.");
                        clearInforDetails();
                    });
            } else {
                clearInforDetails();
            }
        });

        // Xử lý change User
        $('#userSelect').change(function () {
            var id = $(this).val();
            $('#userSelectError').text('');
            if (id) {
                $('#UserId').val(id);
                $.getJSON('/Admin/GetUserDetails', { id: id })
                    .done(function (data) {
                        $('#userName').text(data.name);
                        $('#userEmail').text(data.email);
                        $('#userRole').text(data.role);
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("Error loading user details:", textStatus, errorThrown);
                        $('#userSelectError').text("Failed to load user details. Please try again.");
                        clearUserDetails();
                    });
            } else {
                clearUserDetails();
            }
        });

        // Xử lý Assign
        $('#assignButton').click(function (e) {
            var inforId = $('#InforId').val();
            var userId = $('#UserId').val();
            if (!inforId || !userId) {
                e.preventDefault();
                $('#inforSelectError').text("Please select both an information record and a user.");
            }
        });

        // Hàm clear thông tin
        function clearInforDetails() {
            $('#InforId').val('');
            $('#inforName').text('');
            $('#inforCodeId').text('');
            $('#inforJoinDate').text('');
            $('#inforBirthDate').text('');
            $('#inforPhoneNumber').text('');
        }

        function clearUserDetails() {
            $('#UserId').val('');
            $('#userName').text('');
            $('#userEmail').text('');
            $('#userRole').text('');
        }

        // Validation phía client
        $('form').validate({
            rules: {
                Role: { required: true },
                InforId: { required: true },
                UserId: { required: true }
            },
            messages: {
                Role: { required: "Please select a role." },
                InforId: { required: "Please select an information record." },
                UserId: { required: "Please select a user." }
            }
        });
    });
</script>
}
</body>